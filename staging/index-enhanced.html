<!DOCTYPE html>
<html lang="en">

<!-- Move the Socket.IO script to the head section where it belongs -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch Admin EFE - Loops</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-slate-900 text-slate-200 p-4 sm:p-8">
    <div class="max-w-xl mx-auto space-y-8">
        <!-- Header with Version -->
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-3xl font-bold text-white tracking-tight">EFE Admin Tool</h1>
            <div class="flex items-center space-x-2">
                <span class="text-xs bg-blue-500/50 text-blue-200 px-3 py-1 rounded-full" id="versionBadge">v{{VERSION}}</span>
                <div class="w-2 h-2 bg-green-500 rounded-full" id="statusIndicator" title="System Status"></div>
            </div>
        </div>
        
        <!-- Form Card -->
        <div class="bg-slate-800/50 rounded-xl shadow-lg overflow-hidden border border-slate-700">
            <!-- Tab navigation -->
            <div class="flex border-b border-gray-700">
                <button id="formTab" class="tab-btn py-3 px-4 w-1/2 font-semibold text-white border-b-2 border-blue-500">
                    <i class="fas fa-edit mr-2"></i>Form
                </button>
                <button id="logTab" class="tab-btn py-3 px-4 w-1/2 font-medium text-slate-400 border-b-2 border-transparent hover:bg-slate-700/50">
                    <i class="fas fa-list-ul mr-2"></i>Logs
                    <span id="logCounter" class="ml-2 bg-blue-500 text-white text-xs font-bold w-5 h-5 flex items-center justify-center rounded-full hidden">0</span>
                </button>
            </div>
            
            <!-- Form tab content -->
            <div id="formContent" class="tab-content block p-6">
                <form id="automationForm" class="space-y-4">
                    <div class="block mb-1 font-medium text-sm text-blue-400">
                        Admin Selection <span id="adminCounter" class="text-slate-400"></span>
                    </div>
                    <div id="adminContainer">
                        <!-- Admin fields will be added here dynamically -->
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" name="isManual" value="true" />
                    <input type="hidden" name="timeOfDay" value="manual" />
                    <input type="hidden" name="regularCampaigns" value="true" />
                    <div class="flex justify-center items-center space-x-3 pt-4">
                        <button id="checkPlanButton" type="button" class="font-semibold bg-slate-600 hover:bg-slate-500 text-white px-5 py-2.5 rounded-lg transition-colors">
                            <i class="fas fa-tasks mr-2"></i>Check Plan
                        </button>
                        <button id="automationButton" type="submit" class="font-semibold bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white px-6 py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all">
                            <i class="fas fa-play-circle mr-2"></i>Submit
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Log tab content -->
            <div id="logContent" class="tab-content hidden p-6">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-white">Automation Logs</h2>
                    <button id="clearLogs" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded-md transition-colors">
                        <i class="fas fa-trash-alt mr-1"></i>Clear
                    </button>
                </div>
                <div id="logContainer" class="space-y-2 max-h-96 overflow-y-auto bg-slate-900 p-4 rounded-lg font-mono text-sm"></div>
            </div>
        </div>

        <!-- Plan Check Modal -->
        <div id="planModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center hidden z-50 p-4">
            <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-2xl mx-4 border border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">
                        <i class="fas fa-tasks mr-2 text-blue-400"></i>Automation Plan
                    </h2>
                    <button id="closeModalButton" class="text-slate-400 hover:text-white transition-colors">
                        <i class="fas fa-times fa-lg"></i>
                    </button>
                </div>
                <div id="planContainer" class="space-y-3 max-h-[60vh] overflow-y-auto bg-slate-900 p-4 rounded-lg font-mono text-sm text-white">
                    <!-- Plan content will be populated here -->
                </div>
                <p class="text-xs text-slate-500 mt-4 text-center">Ini adalah simulasi. Klik "Submit" pada form utama untuk menjalankan automasi.</p>
            </div>
        </div>

        <!-- Usage Guide Card -->
        <!-- Usage Guide has been commented out to simplify the UI -->
    </div>

    <script>
        // Define global variables that need to be accessible outside DOMContentLoaded
        let newLogCount = 0;
        let activeTab = 'form';
        let adminCount = 0;
        let customRuleCount = 0;
        
        // Admin options with label/value structure for flexibility
        const adminOptions = [
            { label: "Admin 1", value: "admin 1" },
            { label: "Admin 2", value: "admin 2" },
            { label: "Admin 3", value: "admin 3" },
            { label: "Admin 4", value: "admin 4" },
            { label: "Admin 5", value: "admin 5" },
            { label: "Admin 6", value: "admin 6" },
            { label: "Admin 7", value: "admin 7" },
            { label: "Admin 8", value: "admin 8" },
            { label: "Admin 9", value: "admin 9" },
            { label: "Admin 10", value: "admin 10" },
            { label: "Admin 91", value: "admin 91" },
            { label: "Admin 92", value: "admin 92" }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            // Tab functionality
            const formTab = document.getElementById('formTab');
            const logTab = document.getElementById('logTab');
            const formContent = document.getElementById('formContent');
            const logContent = document.getElementById('logContent');
            const logCounter = document.getElementById('logCounter');
            
            formTab.addEventListener('click', () => {
                switchTab('form');
            });
            
            logTab.addEventListener('click', () => {
                switchTab('log');
                // Reset counter when switching to log tab
                newLogCount = 0;
                logCounter.textContent = newLogCount;
                logCounter.classList.add('hidden');
            });
        
        function switchTab(tab) {
            activeTab = tab;
            const usageGuideCard = document.getElementById('usageGuideCard');
            
            if (tab === 'form') {
                formTab.classList.add('text-white', 'border-blue-500');
                formTab.classList.remove('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                logTab.classList.add('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                logTab.classList.remove('text-white', 'border-blue-500');
                formContent.classList.remove('hidden');
                formContent.classList.add('block');
                logContent.classList.remove('block');
                logContent.classList.add('hidden');
                usageGuideCard.classList.remove('hidden');
            } else if (tab === 'log') {
                formTab.classList.add('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                formTab.classList.remove('text-white', 'border-blue-500');
                logTab.classList.add('text-white', 'border-blue-500');
                logTab.classList.remove('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                formContent.classList.remove('block');
                formContent.classList.add('hidden');
                logContent.classList.remove('hidden');
                logContent.classList.add('block');
                if (usageGuideCard) {
                    usageGuideCard.classList.add('hidden');
                }
            }
        }
        
        // Clear logs functionality
        document.getElementById('clearLogs').addEventListener('click', () => {
            document.getElementById('logContainer').innerHTML = '<div class="text-slate-500 text-center">Logs cleared.</div>';
        });

        const logContainer = document.getElementById('logContainer');
        const startButton = document.getElementById('automationButton');
        const automationForm = document.getElementById('automationForm');
        const adminContainer = document.getElementById('adminContainer');
        // Note: The custom rules functionality has been replaced by inline rules in admin fields

        // Add initial admin field
        addAdminField();

        function toggleCustomRulesInfo() {
            const customRulesInfo = document.getElementById('customRulesInfo');
            const icon = document.querySelector('label[onclick="toggleCustomRulesInfo()"] i');
            
            if (customRulesInfo.classList.contains('hidden')) {
                // Show the content
                customRulesInfo.classList.remove('hidden');
                // Change icon to chevron-up
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                // Hide the content
                customRulesInfo.classList.add('hidden');
                // Change icon to chevron-down
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }

        function createAdminField(index) {
            const adminDiv = document.createElement('div');
            adminDiv.className = 'bg-slate-800/50 p-3 rounded-lg mb-2 border border-slate-700';
            adminDiv.dataset.adminIndex = index;
            
            // Create label
            const label = document.createElement('label');
            label.htmlFor = `admin${index}`;
            label.className = 'block mb-1 font-medium text-blue-400 text-sm hidden';
            label.textContent = `Admin ke-${index}`;
            adminDiv.appendChild(label);
            
            // Create a flex container for select and buttons
            const flexContainer = document.createElement('div');
            flexContainer.className = 'flex items-center space-x-2';
            
            // Create select element
            const select = document.createElement('select');
            select.name = `admin${index}`;
            select.id = `admin${index}`; // Corrected from min-w-[150px] to flex-grow for responsiveness
            select.className = 'flex-grow p-2 border rounded-lg bg-slate-700 text-slate-200 border-slate-600 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition';
            select.required = true;
            
            // Add change event listener to update counter when selection changes
            select.addEventListener('change', updateCounter);
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = 'Select an admin';
            select.appendChild(defaultOption);
            
            // Add admin options
            adminOptions.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.value;  // Use the value property
                option.textContent = admin.label;  // Use the label property for display
                select.appendChild(option);
            });

            // Add select to flex container
            flexContainer.appendChild(select);
            
            // --- NEW: Rule Toggle Button ---
            const ruleToggleButton = document.createElement('button');
            ruleToggleButton.type = 'button';
            ruleToggleButton.className = 'text-slate-400 hover:text-white w-8 h-8 flex items-center justify-center transition-colors';
            ruleToggleButton.innerHTML = '<i class="fas fa-cog"></i>';
            
            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex items-center space-x-1';
            
            // Add the new rule toggle button to the button container
            buttonContainer.appendChild(ruleToggleButton);
            
            // Add plus button
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'bg-green-500/20 hover:bg-green-500/40 text-green-400 w-8 h-8 rounded-full flex items-center justify-center transition-colors ml-auto';
            addButton.innerHTML = '<i class="fas fa-plus"></i>';
            addButton.onclick = (e) => { // Corrected to use addAdminField without arguments for simplicity
                e.preventDefault();
                e.stopPropagation();
                const currentIndex = parseInt(adminDiv.dataset.adminIndex);
                addAdminField(currentIndex + 1);
            };
            
            // Add minus button
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'bg-red-500/20 hover:bg-red-500/40 text-red-400 w-8 h-8 rounded-full flex items-center justify-center transition-colors';
            removeButton.innerHTML = '<i class="fas fa-minus"></i>';
            removeButton.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                const currentIndex = parseInt(adminDiv.dataset.adminIndex);
                removeAdminField(currentIndex);
            };
            
            // Disable remove button if it's the only admin
            if (adminCount <= 1) {
                removeButton.disabled = true;
                removeButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            // --- NEW: Rule Container (initially hidden) ---
            const ruleContainer = document.createElement('div');
            ruleContainer.id = `ruleContainer${index}`;
            ruleContainer.className = 'hidden mt-3 pt-3 border-t border-slate-700 space-y-2';
            
            const ruleLabel = document.createElement('label');
            ruleLabel.className = 'block text-xs font-medium text-slate-400';
            ruleLabel.textContent = 'Inline Rule (Optional)';
            ruleContainer.appendChild(ruleLabel);
            
            const ruleFlexContainer = document.createElement('div');
            ruleFlexContainer.className = 'flex items-center space-x-2';
            
            // Create rule type select (include/exclude)
            const ruleTypeSelect = document.createElement('select');
            ruleTypeSelect.name = `admin${index}_rule_type`;
            ruleTypeSelect.id = `admin${index}_rule_type`;
            ruleTypeSelect.className = 'p-2 border rounded-lg bg-slate-700 text-slate-200 border-slate-600 text-sm w-24 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition';
            
            const defaultRuleOption = document.createElement('option');
            defaultRuleOption.value = '';
            defaultRuleOption.disabled = true;
            defaultRuleOption.selected = true;
            defaultRuleOption.textContent = 'Rule';
            ruleTypeSelect.appendChild(defaultRuleOption);
            
            const includeOption = document.createElement('option');
            includeOption.value = 'include';
            includeOption.textContent = 'Include';
            ruleTypeSelect.appendChild(includeOption);
            
            const excludeOption = document.createElement('option');
            excludeOption.value = 'exclude';
            excludeOption.textContent = 'Exclude';
            ruleTypeSelect.appendChild(excludeOption);
            
            // Create campaign ID input
            const campaignInput = document.createElement('input');
            campaignInput.type = 'text';
            campaignInput.name = `admin${index}_campaign_id`;
            campaignInput.id = `admin${index}_campaign_id`;
            campaignInput.placeholder = 'Campaign ID';
            campaignInput.className = 'flex-grow p-2 border rounded-lg bg-slate-700 text-slate-200 border-slate-600 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition';
            
            // Add rule fields to the flex container
            ruleFlexContainer.appendChild(ruleTypeSelect);
            ruleFlexContainer.appendChild(campaignInput);
            ruleContainer.appendChild(ruleFlexContainer);
            
            // --- Event Listeners for Rule Toggle and Indicator ---
            ruleToggleButton.addEventListener('click', () => {
                ruleContainer.classList.toggle('hidden');
            });

            const updateRuleIndicator = () => {
                const hasRule = ruleTypeSelect.value && campaignInput.value;
                if (hasRule) {
                    ruleToggleButton.classList.add('text-blue-400');
                } else {
                    ruleToggleButton.classList.remove('text-blue-400');
                }
            };
            
            ruleTypeSelect.addEventListener('change', updateRuleIndicator);
            campaignInput.addEventListener('input', updateRuleIndicator);
            
            buttonContainer.appendChild(addButton);
            buttonContainer.appendChild(removeButton);
            
            flexContainer.appendChild(buttonContainer);
            
            // Add flex container to admin div
            adminDiv.appendChild(flexContainer);
            // Add the hidden rule container to the admin div
            adminDiv.appendChild(ruleContainer);
            
            return adminDiv;
        }
        
        function createCustomRuleField(index) {
            const ruleDiv = document.createElement('div');
            ruleDiv.className = 'flex items-center space-x-2 p-2 bg-gray-700 rounded';
            ruleDiv.dataset.ruleIndex = index;
            
            // Create admin select for the rule
            const adminSelect = document.createElement('select');
            adminSelect.name = `customRuleAdmin${index}`;
            adminSelect.id = `customRuleAdmin${index}`;
            adminSelect.className = 'flex-grow p-1 border rounded bg-gray-600 text-gray-200 border-gray-500 text-sm';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = 'Select Admin';
            adminSelect.appendChild(defaultOption);
            
            // Add admin options
            adminOptions.forEach(admin => {
                const option = document.createElement('option');
                option.value = admin.value;
                option.textContent = admin.label;
                adminSelect.appendChild(option);
            });
            
            // Create action select (include/exclude)
            const actionSelect = document.createElement('select');
            actionSelect.name = `customRuleAction${index}`;
            actionSelect.className = 'p-1 border rounded bg-gray-600 text-gray-200 border-gray-500 text-sm';
            
            const includeOption = document.createElement('option');
            includeOption.value = 'include';
            includeOption.textContent = 'Include';
            actionSelect.appendChild(includeOption);
            
            const excludeOption = document.createElement('option');
            excludeOption.value = 'exclude';
            excludeOption.textContent = 'Exclude';
            actionSelect.appendChild(excludeOption);
            
            // Create campaign ID input
            const campaignInput = document.createElement('input');
            campaignInput.type = 'text';
            campaignInput.name = `customRuleCampaign${index}`;
            campaignInput.placeholder = 'Campaign ID';
            campaignInput.className = 'flex-grow p-1 border rounded bg-gray-600 text-gray-200 border-gray-500 text-sm';
            
            // Create remove button
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded text-sm';
            removeButton.innerHTML = '<i class="fas fa-times"></i>';
            removeButton.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                removeCustomRuleField(index);
            };
            
            // Add elements to rule div
            ruleDiv.appendChild(adminSelect);
            ruleDiv.appendChild(actionSelect);
            ruleDiv.appendChild(campaignInput);
            ruleDiv.appendChild(removeButton);
            
            return ruleDiv;
        }

        function reindexAdminFields() {
            const adminDivs = Array.from(adminContainer.querySelectorAll('div[data-admin-index]'));
            adminDivs.sort((a, b) => parseInt(a.dataset.adminIndex) - parseInt(b.dataset.adminIndex));
            
            adminDivs.forEach((div, i) => {
                const newIndex = i + 1;
                div.dataset.adminIndex = newIndex;
                
                // Update label
                const label = div.querySelector('label');
                label.htmlFor = `admin${newIndex}`;
                label.textContent = `Admin ke-${newIndex}`;
                
                // Update select
                const select = div.querySelector('select');
                select.name = `admin${newIndex}`;
                select.id = `admin${newIndex}`;
            });
        }
        


        function addAdminField(positionIndex) {
            adminCount++;
            const newAdminField = createAdminField(adminCount);
            
            if (positionIndex) {
                // Insert at specific position
                const adminDivs = Array.from(adminContainer.querySelectorAll('div[data-admin-index]'));
                let inserted = false;
                
                adminDivs.sort((a, b) => parseInt(a.dataset.adminIndex) - parseInt(b.dataset.adminIndex));
                
                for (let i = 0; i < adminDivs.length; i++) {
                    const currentIndex = parseInt(adminDivs[i].dataset.adminIndex);
                    if (currentIndex >= positionIndex) {
                        adminContainer.insertBefore(newAdminField, adminDivs[i]);
                        inserted = true;
                        break;
                    }
                }
                
                if (!inserted) {
                    adminContainer.appendChild(newAdminField);
                }
            } else {
                // Append at the end
                adminContainer.appendChild(newAdminField);
            }
            
            reindexAdminFields();
            updateRemoveButtons();
        }
        

        function removeAdminField(index) {
            if (adminCount > 1) {
                const adminDivToRemove = adminContainer.querySelector(`div[data-admin-index="${index}"]`);
                if (adminDivToRemove) {
                    adminDivToRemove.remove();
                    adminCount--;
                    reindexAdminFields();
                    updateCounter(); // Update counter on remove
                }
            }
        }
        


        function updateRemoveButtons() {
            const removeButtons = adminContainer.querySelectorAll('button:has(.fa-minus)');
            
            removeButtons.forEach(button => {
                if (adminCount <= 1) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        // Modified addLog function to update counter
        function addLog(message, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('p');
            logEntry.className = `opacity-0 transition-opacity duration-300`;
            logEntry.innerHTML = `<span class="text-slate-500 mr-2">[${timestamp}]</span> <span class="${isError ? 'text-red-400' : 'text-slate-300'}">${message}</span>`;
            logContainer.prepend(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Trigger fade-in effect
            setTimeout(() => {
                logEntry.classList.remove('opacity-0');
            }, 50);
            
            // Update counter if not on log tab
            if (activeTab !== 'log') {
                newLogCount++;
                logCounter.textContent = newLogCount;
                logCounter.classList.remove('hidden'); // Corrected to show counter
            }
        }

        function resetForm() {
            // Reset admin fields
            const adminFields = adminContainer.querySelectorAll('div[data-admin-index]');
            // Remove all admin fields except the first one
            for (let i = adminFields.length - 1; i > 0; i--) {
                adminFields[i].remove();
            }
            // Reset the first admin field's select value
            if (adminFields[0]) {
                adminFields[0].querySelector(`select[name="admin1"]`).value = '';
                adminFields[0].querySelector(`select[name="admin1_rule_type"]`).value = '';
                adminFields[0].querySelector(`input[name="admin1_campaign_id"]`).value = '';
            }
            adminCount = 1;
            
            // Reset the button
            resetButton();
            updateCounter();
        }


        // Create socket connection
        const socket = io();
        
        // Listen for console logs from the backend
        socket.on('console_logs', (logEntry) => {
        // Use the existing addLog function to display console logs
        addLog(`[Backend] ${logEntry.message}`, logEntry.isError);
        });
        
        // Custom rules functionality has been replaced with inline admin rules
        // addCustomRuleBtn.addEventListener('click', addCustomRuleField);
        
        automationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            changeButtonText();

            const { formData, inlineRules } = prepareFormData();
            
            addLog(`Starting automation...`);
            const activeRules = inlineRules.filter(r => r.ruleType && r.campaignId);
            if (activeRules.length > 0) {
                addLog(`Active inline rules: ${JSON.stringify(activeRules)}`, false);
            }

            try {
                const response = await fetch('/run', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });

                const result = await response.json();
                if (response.ok) {
                    const jobId = result.jobId;
                    addLog('Processing your request...', false);
                    
                    // Subscribe to real-time updates for this job
                    socket.emit('subscribeToJob', jobId);
                    
                    // Listen for new logs
                    socket.on('newLog', (logEntry) => {
                        addLog(logEntry.message, logEntry.isError, jobId);
                        
                        // Check if job is completed
                        if (logEntry.message.includes('Automation completed')) {
                            if (!logEntry.isError) {
                                addLog('Automation completed successfully! ‚úÖ', false);
                                resetForm();
                            } else {
                                addLog('Automation completed with errors ‚ùå', true);
                                resetButton();
                            }
                            socket.off('newLog');
                        }
                    });
                    
                    // Backup check for job completion
                    const completionCheck = setInterval(async () => {
                        try {
                            const statusResponse = await fetch(`/status/${jobId}`);
                            const statusResult = await statusResponse.json();
                            
                            if (statusResult.status === 'completed' || statusResult.status === 'error') {
                                clearInterval(completionCheck);
                                socket.off('newLog');
                                
                                if (statusResult.status === 'completed') {
                                    addLog('Automation completed successfully! ‚úÖ', false);
                                    resetForm();
                                } else {
                                    addLog(`Error: ${statusResult.message} ‚ùå`, true);
                                    resetButton();
                                }
                            }
                        } catch (error) {
                            console.error('Error checking job status:', error);
                            clearInterval(completionCheck);
                            socket.off('newLog');
                            addLog('Error checking job status ‚ùå', true);
                            resetButton();
                        }
                    }, 5000); // Check every 5 seconds
                    
                    // Clear the interval after 10 minutes (timeout)
                    setTimeout(() => {
                        clearInterval(completionCheck);
                        socket.off('newLog');
                        addLog('Job status check timed out ‚ùå', true);
                        resetButton();
                    }, 600000);
                } else {
                    addLog(`Error: ${result.message || 'Failed to start automation'} ‚ùå`, true);
                    resetButton();
                }
            } catch (error) {
                console.error('Error:', error);
                addLog('Failed to start automation ‚ùå', true);
                resetButton();
            }
        });

        function changeButtonText() {
            const button = document.getElementById("automationButton");
            button.textContent = "Processing...";
            button.disabled = true; // Disable button to prevent multiple submissions
            button.classList.add("opacity-50", "cursor-not-allowed"); // Styling for disabled state
        }

        function resetButton() {
            const button = document.getElementById('automationButton');
            button.disabled = false;
            // Corrected to use innerHTML to include icon
            button.innerHTML = '<i class="fas fa-play-circle mr-2"></i>Submit';
            button.classList.remove("opacity-50", "cursor-not-allowed"); 
        }

        // Add a function to format duration
        function formatDuration(startTime, endTime) {
            const duration = Math.floor((new Date(endTime) - new Date(startTime)) / 1000);
            return `${duration} seconds`;
        }

        // Update the counter function to count only selected admins
        function updateCounter() {
            const counter = document.getElementById('adminCounter');
            const selects = adminContainer.querySelectorAll('select');
            const selectedCount = Array.from(adminContainer.querySelectorAll('select[name^="admin"]')).filter(select => select.value !== '').length;
            counter.textContent = `(${selectedCount})`;
        }

        // Guide toggle functionality is removed as the guide is commented out
        // const toggleGuide = document.getElementById('toggleGuide');
        // if (toggleGuide) {
        //     toggleGuide.addEventListener('click', function() {
        //         const guideContent = document.getElementById('guideContent');
        //         const chevron = this.querySelector('.fa-chevron-down');
        //         guideContent.classList.toggle('hidden');
        //         chevron.style.transform = guideContent.classList.contains('hidden') ? 'rotate(0deg)' : 'rotate(180deg)';
        //     });
        // }

        // --- Plan Check Modal Functionality ---
        const checkPlanButton = document.getElementById('checkPlanButton');
        const planModal = document.getElementById('planModal');
        const closeModalButton = document.getElementById('closeModalButton');
        const planContainer = document.getElementById('planContainer');

        checkPlanButton.addEventListener('click', async () => {
            planContainer.innerHTML = '<div class="text-center text-slate-400"><i class="fas fa-spinner fa-spin mr-2"></i>Generating plan...</div>';
            planModal.classList.remove('hidden');

            const { formData } = prepareFormData();

            try {
                const response = await fetch('/check-plan', {
                    method: 'POST',
                    body: new URLSearchParams(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    displayPlan(result.plan);
                } else {
                    planContainer.innerHTML = `<div class="text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Error: ${result.message || 'Failed to generate plan.'}</div>`;
                }
            } catch (error) {
                console.error('Error checking plan:', error);
                planContainer.innerHTML = '<div class="text-red-400"><i class="fas fa-server mr-2"></i>Failed to connect to server to generate plan.</div>';
            }
        });

        closeModalButton.addEventListener('click', () => {
            planModal.classList.add('hidden');
        });

        // Close modal if clicking outside of it
        planModal.addEventListener('click', (e) => {
            if (e.target === planModal) {
                planModal.classList.add('hidden');
            }
        });

        function displayPlan(plan) {
            if (!plan || plan.length === 0) {
                planContainer.innerHTML = '<div class="text-slate-400 text-center">No campaigns to process based on current selection.</div>';
                return;
            }

            let html = plan.map(item => {
                const excludedText = item.excludedAdmins.length > 0 ? `Excluded: <span class="text-red-400 font-semibold">[${item.excludedAdmins.join(', ')}]</span>` : 'No exclusions.';
                const processingText = item.processingAdmins.length > 0 ? `Processing with: <span class="text-green-400 font-semibold">[${item.processingAdmins.join(', ')}]</span>` : '<span class="text-yellow-400 font-semibold">SKIPPED</span>';
                
                return `<div class="border-b border-slate-700 pb-3 mb-3 last:border-b-0 last:pb-0 last:mb-0"><strong class="text-white">Campaign ${item.campaignId}</strong><br><span class="text-slate-400">üîç ${excludedText} &rarr; ${processingText}</span></div>`;
            }).join('');

            planContainer.innerHTML = html;
        }

        // --- NEW: Centralized function to prepare form data ---
        function prepareFormData() {
            const formData = new FormData(automationForm);
            const inlineRules = [];
            const adminFields = adminContainer.querySelectorAll('div[data-admin-index]');

            adminFields.forEach(adminField => {
                const index = adminField.dataset.adminIndex;
                const ruleTypeSelect = adminField.querySelector(`select[name="admin${index}_rule_type"]`);
                const campaignInput = adminField.querySelector(`input[name="admin${index}_campaign_id"]`);

                if (ruleTypeSelect && campaignInput) {
                    const rule = {
                        admin: adminField.querySelector(`select[name="admin${index}"]`).value,
                        ruleType: ruleTypeSelect.value || null,
                        campaignId: campaignInput.value || null
                    };
                    inlineRules.push(rule);

                    // The backend expects 'inlineRuleType' and 'inlineRuleCampaign' prefixes.
                    // We add them here, but we don't need to add the original admin rule fields
                    // as they are already part of the FormData from the form.
                    formData.append(`inlineRuleType${index}`, rule.ruleType || '');
                    formData.append(`inlineRuleCampaign${index}`, rule.campaignId || '');
                }
            });
            return { formData, inlineRules };
        }

        // Exclusion toggle functionality removed - now using dynamic restrictions

        // Fetch and display version information
        async function fetchVersion() {
            try {
                const response = await fetch('/version');
                const data = await response.json();
                
                // Update version badge
                document.getElementById('versionBadge').textContent = `v${data.version}`;
                
                // Update status indicator to show server is connected
                const statusIndicator = document.getElementById('statusIndicator');
                statusIndicator.classList.add('bg-green-500');
                statusIndicator.classList.remove('bg-red-500', 'bg-yellow-500');
                statusIndicator.title = `Server Connected - Version ${data.version}`;
                
                console.log(`App Version: ${data.version}`);
            } catch (error) {
                console.error('Error fetching version:', error);
                
                // Update status indicator to show error
                const statusIndicator = document.getElementById('statusIndicator');
                statusIndicator.classList.add('bg-red-500');
                statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
                statusIndicator.title = 'Server Connection Error';
            }
        }

        function displayRestrictions(data) {
            const restrictionContent = document.getElementById('restrictionContent');
            
            // Check if we're getting the new payload-based configuration
            if (data.message && data.supportedRuleTypes) {
                // This is the staging server with payload-based rules
                let html = '';
                
                html += `
                    <div>
                        <h4 class="font-medium text-gray-300 mb-2 text-sm">Sistem Pembatasan Baru:</h4>
                        <div class="bg-blue-900/30 border border-blue-500/30 p-3 rounded mb-3">
                            <p class="text-blue-200 text-sm mb-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                Server menggunakan sistem aturan berbasis payload
                            </p>
                            <ul class="list-disc list-inside space-y-1 text-gray-300 text-sm">
                                <li>Aturan diterapkan per-admin saat submit form</li>
                                <li>Jenis aturan: <span class="font-mono bg-gray-700 px-1 rounded">include</span> (hanya campaign tertentu) atau <span class="font-mono bg-gray-700 px-1 rounded">exclude</span> (kecuali campaign tertentu)</li>
                                <li>Tanpa aturan: admin dapat proses semua campaign</li>
                            </ul>
                        </div>
                        
                        <h4 class="font-medium text-gray-300 mb-1 text-sm">Cara Menggunakan:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 text-sm">
                            <li>Pilih admin dari dropdown</li>
                            <li>(Opsional) Pilih jenis aturan: Include/Exclude</li>
                            <li>(Opsional) Masukkan Campaign ID untuk diterapkan aturan</li>
                            <li>Submit untuk memproses campaign dengan aturan yang ditentukan</li>
                        </ul>
                    </div>
                `;
                
                restrictionContent.innerHTML = html;
            } else {
                // This is the legacy configuration (backward compatibility)
                const { adminCampaignRestrictions, conditionalRestrictions } = data;
                
                let html = '';
                
                // Regular Restrictions
                html += `
                    <div>
                        <h4 class="font-medium text-gray-300 mb-1 text-sm">Pembatasan Reguler:</h4>
                        <ul class="list-disc list-inside space-y-1 text-gray-300 text-sm">
                `;
                
                // Group admins by their restrictions
                const excludedAdmins = [];
                Object.entries(adminCampaignRestrictions).forEach(([admin, restriction]) => {
                    if (restriction.exclude && restriction.exclude.includes(247001)) {
                        excludedAdmins.push(admin);
                    }
                });
                
                if (excludedAdmins.length > 0) {
                    html += `<li><strong class="text-gray-200">${excludedAdmins.join(', ')}:</strong> Tidak dapat memproses campaign 247001</li>`;
                }
                
                html += `
                            <li><strong class="text-gray-200">Admin lainnya:</strong> Dapat memproses semua campaign (kecuali pembatasan Kondisional)</li>
                        </ul>
                    </div>
                `;
                
                // Conditional Restrictions
                if (conditionalRestrictions && conditionalRestrictions['admin 91']) {
                    const conditionalData = conditionalRestrictions['admin 91'];
                    
                    html += `
                        <div class="bg-slate-700/50 border border-gray-600 p-3 rounded">
                            <h4 class="font-medium text-gray-300 mb-2 text-sm">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Pembatasan Kondisional (admin 91):
                            </h4>
                            <div class="space-y-2">
                                <p class="text-gray-300 text-sm mb-1">
                                    <strong>Ketika admin 91 dipilih:</strong>
                                </p>
                                <ul class="list-disc list-inside space-y-1 text-gray-300 text-sm ml-4">
                    `;
                    
                    if (conditionalData.whenPresent && conditionalData.whenPresent.restrictSpecificAdmins) {
                        const restrictedAdmins = Object.keys(conditionalData.whenPresent.restrictSpecificAdmins);
                        if (restrictedAdmins.length > 0) {
                            html += `<li><strong class="text-gray-200">${restrictedAdmins.join(' & ')}:</strong> Hanya dapat memproses campaign 247001</li>`;
                        }
                    }
                    
                    html += `
                                    <li><strong class="text-gray-200">Admin lainnya:</strong> Mengikuti pembatasan reguler mereka</li>
                                    <li><strong class="text-red-300">admin 91:</strong> Tidak dapat memproses campaign 247001, dapat memproses campaign lainnya</li>
                                </ul>
                                <div class="bg-red-900/30 border border-red-500/30 p-2 rounded mt-2">
                                    <p class="text-red-200 text-xs">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        <strong>Catatan:</strong> Ketika admin 91 aktif, Admin 1 dan Admin 5 akan dibatasi hanya untuk campaign 247001 saja.
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // General info
                html += `
                    <ul class="list-disc list-inside space-y-1 text-gray-300 text-sm">
                        <li>Pembatasan dikelola secara otomatis melalui konfigurasi server</li>
                        <li>Sistem akan otomatis memfilter admin berdasarkan pembatasan campaign</li>
                        <li>Conditional restrictions memiliki prioritas lebih tinggi dari pembatasan reguler</li>
                    </ul>
                `;
                
                restrictionContent.innerHTML = html;
            }
        }
        
        // Fetch version on page load
        fetchVersion();
        
        // Also fetch version every 30 seconds to keep status updated
        setInterval(fetchVersion, 30000);
        
        });
    </script>
</body>
</html>