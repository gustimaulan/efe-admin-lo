<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch Admin EFE - Loops</title>

    <!-- External CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Disable Tailwind CDN warning in production
        if (window.location.hostname !== 'localhost') {
            const originalWarn = console.warn;
            console.warn = function (...args) {
                if (args[0] && args[0].includes('should not be used in production')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --neo-yellow: #FFD600;
            --neo-pink: #FF008A;
            --neo-cyan: #00F0FF;
            --neo-black: #000000;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F3F3;
            color: var(--neo-black);
        }

        h1,
        h2,
        h3,
        .heading-font {
            font-family: 'Lexend', sans-serif;
        }

        .neo-border {
            border: 2px solid var(--neo-black);
        }

        .neo-shadow {
            box-shadow: 4px 4px 0px 0px var(--neo-black);
        }

        .neo-shadow-sm {
            box-shadow: 2.5px 2.5px 0px 0px var(--neo-black);
        }

        .neo-button {
            border: 2px solid var(--neo-black);
            box-shadow: 3px 3px 0px 0px var(--neo-black);
            border-radius: 0.75rem;
            transition: all 0.1s ease;
        }

        .neo-button:hover {
            transform: translate(-1px, -1px);
            box-shadow: 4px 4px 0px 0px var(--neo-black);
        }

        .neo-button:active {
            transform: translate(1px, 1px);
            box-shadow: 0px 0px 0px 0px var(--neo-black);
        }

        .neo-card {
            background-color: white;
            border: 2.5px solid var(--neo-black);
            box-shadow: 6px 6px 0px 0px var(--neo-black);
            border-radius: 1.5rem;
        }

        .tab-btn {
            transition: all 0.2s;
            border-bottom: 2.5px solid transparent;
        }

        .tab-btn.active {
            background-color: var(--neo-yellow);
            border-bottom: 2.5px solid var(--neo-black);
            color: var(--neo-black);
            font-weight: 700;
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <div class="max-w-xl mx-auto space-y-10">
        <!-- Header with Version -->
        <header class="flex justify-between items-end mb-4">
            <div>
                <h1 class="text-4xl font-extrabold text-black tracking-tighter uppercase italic">EFE ADMIN</h1>
                <p class="text-sm font-bold text-black opacity-60 uppercase tracking-widest">Loops Panel</p>
            </div>
            <div class="flex flex-col items-end space-y-2">
                <span class="text-xs font-bold bg-cyan-400 border-2 border-black px-3 py-1 neo-shadow-sm rounded-lg"
                    id="versionBadge">v{{VERSION}}</span>
                <div class="flex items-center space-x-3">
                    <button id="reloadButton"
                        class="text-[10px] font-black bg-pink-400 border-2 border-black px-3 py-1 neo-shadow-sm rounded-lg hover:translate-x-0.5 hover:translate-y-0.5 hover:shadow-none transition-all uppercase"
                        title="Reload Server (PM2 Restart)">
                        <i class="fas fa-sync-alt mr-1"></i>RELOAD
                    </button>
                    <div class="flex items-center space-x-2">
                        <span class="text-[10px] font-bold uppercase">Status:</span>
                        <div class="w-4 h-4 border-2 border-black transition-colors duration-300 rounded-full"
                            id="statusIndicator" title="System Status"></div>
                    </div>
                </div>
            </div>
        </header>


        <!-- Main Content Card -->
        <main class="neo-card overflow-hidden">

            <!-- Tab navigation -->
            <nav class="flex border-b-2 border-black bg-white">
                <button id="formTab"
                    class="tab-btn active py-4 px-4 w-1/3 font-extrabold text-black border-r-2 border-black">
                    <i class="fas fa-edit mr-2 text-lg"></i>FORM
                </button>
                <button id="logTab"
                    class="tab-btn py-4 px-4 w-1/3 font-bold text-black border-r-2 border-black hover:bg-pink-400">
                    <i class="fas fa-list-ul mr-2 text-lg"></i>LOGS
                    <span id="logCounter"
                        class="ml-2 bg-white border-2 border-black text-black text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-sm hidden">0</span>
                </button>
                <button id="historyTab" class="tab-btn py-4 px-4 w-1/3 font-bold text-black hover:bg-cyan-400">
                    <i class="fas fa-history mr-2 text-lg"></i>HISTORY
                </button>
            </nav>




            <!-- Form tab content -->
            <section id="formContent" class="tab-content block p-6 bg-white">
                <form id="automationForm" class="space-y-6">
                    <div class="block p-5 bg-yellow-300 border-2 border-black neo-shadow-sm rounded-xl">
                        <label class="block mb-3 font-extrabold text-sm uppercase italic">Browser Selection</label>
                        <div class="flex space-x-6">
                            <label class="inline-flex items-center cursor-pointer group">
                                <input type="radio" name="browserType" value="local"
                                    class="w-5 h-5 border-2 border-black focus:ring-0 checked:bg-black rounded-md"
                                    checked>
                                <span class="ml-2 text-sm font-extrabold uppercase">Local</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer group">
                                <input type="radio" name="browserType" value="remote"
                                    class="w-5 h-5 border-2 border-black focus:ring-0 checked:bg-black rounded-md">
                                <span class="ml-2 text-sm font-extrabold uppercase">Remote <span
                                        class="text-[10px] bg-black text-white px-1 ml-1 rounded-sm tracking-tighter">BCAT</span></span>
                            </label>
                        </div>
                    </div>


                    <div>
                        <label class="block mb-2 font-black text-sm uppercase italic">
                            Select Admins <span id="adminCounter" class="opacity-40"></span>
                        </label>
                        <div id="adminContainer" class="space-y-3">
                            <!-- Admin fields will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" name="isManual" value="true" />
                    <input type="hidden" name="timeOfDay" value="manual" />
                    <input type="hidden" name="regularCampaigns" value="true" />

                    <!-- Form actions -->
                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <button id="checkPlanButton" type="button"
                            class="neo-button font-black bg-white text-black py-3 px-4 uppercase italic">
                            CHECK PLAN
                        </button>
                        <button id="automationButton" type="submit"
                            class="neo-button font-black bg-yellow-400 text-black py-3 px-4 uppercase italic">
                            RUN PROCESS
                        </button>
                    </div>
                </form>
            </section>


            <!-- Log tab content -->
            <section id="logContent" class="tab-content hidden p-6 bg-pink-50">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-black uppercase italic">Activity Logs</h2>
                    <button id="clearLogs" class="neo-button text-[10px] bg-white font-black px-4 py-1 uppercase">
                        TRASH
                    </button>
                </div>
                <div id="logContainer"
                    class="space-y-2 max-h-96 overflow-y-auto bg-white border-4 border-black p-4 font-mono text-xs text-black">
                    <!-- Log entries will be added here dynamically -->
                </div>
            </section>

            <!-- History tab content -->
            <section id="historyContent" class="tab-content hidden p-6 bg-cyan-50">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black text-black uppercase italic">Past Jobs</h2>
                    <button id="refreshHistory" class="neo-button text-[10px] bg-white font-black px-4 py-1 uppercase">
                        FETCH
                    </button>
                </div>
                <div id="historyList" class="space-y-4 max-h-96 overflow-y-auto p-1">
                    <!-- History entries will be added here dynamically -->
                    <div class="text-center py-10">
                        <div class="inline-block p-4 border-4 border-black bg-white neo-shadow-sm mb-4">
                            <i class="fas fa-history fa-2x opacity-20"></i>
                        </div>
                        <p class="font-black text-black opacity-30 uppercase">Empty Archive</p>
                    </div>
                </div>
            </section>

        </main>


        <!-- Plan Check Modal -->
        <div id="planModal"
            class="fixed inset-0 bg-black/30 backdrop-blur-sm flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white border-2 border-black neo-shadow p-6 w-full max-w-2xl mx-4 rounded-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-extrabold text-black tracking-tight">
                        PLANNING BOARD
                    </h2>
                    <button id="closeModalButton" class="hover:rotate-90 transition-transform duration-200">
                        <i class="fas fa-times fa-2x"></i>
                    </button>
                </div>
                <div id="planContainer"
                    class="space-y-4 max-h-[60vh] overflow-y-auto bg-yellow-50 border-2 border-black p-5 font-mono text-sm text-black rounded-xl">
                    <!-- Plan content will be added here dynamically -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center py-6 border-2 border-black bg-white neo-shadow mt-10 rounded-2xl">
            <p class="font-bold text-xs uppercase italic tracking-widest">ENV: {{ENVIRONMENT}} | ACTIVE: {{ACTIVE_ENV}}
            </p>
        </footer>
    </div>



    <!-- External JavaScript -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Consolidated Application Logic -->
    <script>
        /**
         * EFE Admin Tool - Frontend Application
         */

        class EFEAdminApp {
            constructor() {
                this.newLogCount = 0;
                this.activeTab = 'form';
                this.adminCount = 0;
                this.currentConfig = {};
                this.adminOptions = [];
                this.socket = null;
                this.currentJobId = null;
                this.isReloading = false;
                this.originalReloadButtonHtml = '';

                this.init();
            }

            async init() {
                this.cacheDOMElements();
                this.bindEvents();
                await this.loadAdminOptions();
                this.initializeSocket();
                this.addAdminField();
            }

            cacheDOMElements() {
                // Tab elements
                this.formTab = document.getElementById('formTab');
                this.logTab = document.getElementById('logTab');
                this.historyTab = document.getElementById('historyTab');
                this.formContent = document.getElementById('formContent');
                this.logContent = document.getElementById('logContent');
                this.historyContent = document.getElementById('historyContent');
                this.logCounter = document.getElementById('logCounter');


                // Form elements
                this.automationForm = document.getElementById('automationForm');
                this.adminContainer = document.getElementById('adminContainer');
                this.automationButton = document.getElementById('automationButton');
                this.checkPlanButton = document.getElementById('checkPlanButton');

                // Log elements
                this.logContainer = document.getElementById('logContainer');
                this.clearLogsButton = document.getElementById('clearLogs');

                // History elements
                this.historyList = document.getElementById('historyList');
                this.refreshHistoryButton = document.getElementById('refreshHistory');


                // Modal elements
                this.planModal = document.getElementById('planModal');
                this.closeModalButton = document.getElementById('closeModalButton');
                this.planContainer = document.getElementById('planContainer');

                // Status elements
                this.versionBadge = document.getElementById('versionBadge');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.reloadButton = document.getElementById('reloadButton');
            }

            bindEvents() {
                // Tab switching
                this.formTab.addEventListener('click', () => this.switchTab('form'));
                this.logTab.addEventListener('click', () => {
                    this.switchTab('log');
                    this.resetLogCounter();
                });
                this.historyTab.addEventListener('click', () => {
                    this.switchTab('history');
                    this.fetchHistory();
                });


                // Form events
                this.automationForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
                this.checkPlanButton.addEventListener('click', () => this.handleCheckPlan());
                this.clearLogsButton.addEventListener('click', () => this.clearLogs());
                this.refreshHistoryButton.addEventListener('click', () => this.fetchHistory());


                // Modal events
                this.closeModalButton.addEventListener('click', () => this.closeModal());
                this.planModal.addEventListener('click', (e) => {
                    if (e.target === this.planModal) this.closeModal();
                });

                // Reload event
                this.reloadButton.addEventListener('click', () => this.handleReload());
            }

            async loadAdminOptions() {
                // Temporary: Hardcoded admin options as requested
                const allowedAdmins = [
                    "admin 1", "admin 2", "admin 3", "admin 4", "admin 5",
                    "admin 6", "admin 7", "admin 8", "admin 09", "admin 10",
                    "admin 91", "admin 92", "admin 914", "admin 915",
                    "admin 916", "admin 917", "admin 918"
                ];

                this.adminOptions = allowedAdmins.map(name => ({
                    label: name,
                    value: name
                }));

                // Still try to fetch config for other settings silently, but don't block UI if it fails
                try {
                    const response = await fetch('/api/config');
                    const result = await response.json();
                    if (result.success) {
                        this.currentConfig = result.data;
                        this.updateVersionBadge();
                    }
                } catch (error) {
                    console.warn('Background config fetch failed, using defaults');
                }
            }

            initializeSocket() {
                // Initialize Socket.IO with specific transports and relative path to support both HTTP and HTTPS
                this.socket = io({
                    transports: ['polling', 'websocket'],
                    // Force insecure connection (HTTP/WS) as requested for IP address usage
                    secure: false,
                    rejectUnauthorized: false
                });

                this.socket.on('connect', () => {
                    this.addLog('Connected to server via WebSocket.', false);
                    this.updateStatusIndicator(true);

                    if (this.isReloading) {
                        this.resetReloadButton();
                    }
                });

                this.socket.on('disconnect', () => {
                    this.addLog('Disconnected from server.', true);
                    this.updateStatusIndicator(false);
                });

                this.socket.on('console_logs', (logEntry) => {
                    this.addLog(`[Backend] ${logEntry.message}`, logEntry.isError);
                });

                this.socket.on('newLog', (logEntry) => {
                    const message = logEntry.message.trim();
                    this.addLog(message, logEntry.isError);

                    if (this.isJobCompleteMessage(message)) {
                        this.handleJobCompletion(logEntry);
                    }
                });
            }

            switchTab(tab) {
                this.activeTab = tab;

                // Select tab buttons and contents
                const tabs = {
                    form: { btn: this.formTab, content: this.formContent },
                    log: { btn: this.logTab, content: this.logContent },
                    history: { btn: this.historyTab, content: this.historyContent }
                };


                // Reset all tabs
                Object.values(tabs).forEach(({ btn, content }) => {
                    btn.classList.remove('active', 'text-white', 'border-blue-500');
                    btn.classList.add('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                    content.classList.add('hidden');
                });

                // Set active tab
                const active = tabs[tab];
                active.btn.classList.remove('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                active.btn.classList.add('active', 'text-white', 'border-blue-500');
                active.content.classList.remove('hidden');

                if (tab === 'form' && this.adminContainer.children.length === 0) {
                    this.addAdminField();
                }
            }

            createAdminField(index) {
                const adminDiv = document.createElement('div');
                adminDiv.className = 'bg-white p-4 border-2 border-black neo-shadow-sm mb-4 rounded-xl opacity-0 transition-all duration-300';
                adminDiv.dataset.adminIndex = index;

                const flexContainer = document.createElement('div');
                flexContainer.className = 'flex items-center space-x-3';

                const select = this.createAdminSelect(index);
                const buttonContainer = this.createButtonContainer();

                flexContainer.appendChild(select);
                flexContainer.appendChild(buttonContainer);
                adminDiv.appendChild(flexContainer);

                // Trigger opacity transition
                setTimeout(() => adminDiv.classList.remove('opacity-0'), 10);

                return adminDiv;
            }

            createAdminSelect(index) {
                const select = document.createElement('select');
                select.name = `admin${index}`;
                select.className = 'flex-grow p-3 border-2 border-black text-black font-extrabold uppercase text-sm focus:bg-yellow-100 focus:outline-none transition-all rounded-lg';
                select.required = true;



                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                defaultOption.textContent = 'Select an admin';
                select.appendChild(defaultOption);

                this.adminOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    select.appendChild(option);
                });

                return select;
            }

            createButtonContainer() {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex items-center space-x-1';

                const addButton = this.createAddButton();
                const removeButton = this.createRemoveButton();

                buttonContainer.appendChild(addButton);
                buttonContainer.appendChild(removeButton);

                return buttonContainer;
            }

            createAddButton() {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'bg-cyan-400 border-2 border-black w-10 h-10 flex items-center justify-center rounded-lg neo-shadow-sm hover:translate-x-0.5 hover:translate-y-0.5 hover:shadow-none transition-all';
                button.innerHTML = '<i class="fas fa-plus font-bold"></i>';
                button.onclick = () => this.addAdminField();
                return button;
            }

            createRemoveButton() {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'rmv bg-pink-400 border-2 border-black w-10 h-10 flex items-center justify-center rounded-lg neo-shadow-sm hover:translate-x-0.5 hover:translate-y-0.5 hover:shadow-none transition-all';
                button.innerHTML = '<i class="fas fa-minus font-bold"></i>';
                button.onclick = (e) => {
                    const field = e.target.closest('[data-admin-index]');
                    this.removeAdminField(field);
                };
                return button;
            }



            addAdminField() {
                this.adminCount++;
                const newField = this.createAdminField(this.adminCount);
                this.adminContainer.appendChild(newField);
                this.updateRemoveButtons();
                this.updateAdminCounter();
            }

            removeAdminField(field) {
                if (this.adminCount > 1) {
                    field.classList.add('opacity-0');
                    setTimeout(() => {
                        field.remove();
                        this.adminCount--;
                        this.updateRemoveButtons();
                        this.updateAdminCounter();
                    }, 300);
                }
            }

            updateRemoveButtons() {
                const removeButtons = this.adminContainer.querySelectorAll('.rmv');
                removeButtons.forEach(button => {
                    const disabled = this.adminCount <= 1;
                    button.disabled = disabled;
                    button.classList.toggle('opacity-50', disabled);
                    button.classList.toggle('cursor-not-allowed', disabled);
                });
            }

            updateAdminCounter() {
                const counter = document.getElementById('adminCounter');
                if (counter) {
                    counter.textContent = `(${this.adminCount})`;
                }
            }

            async handleReload() {
                if (!confirm('Are you sure you want to reload the server? This will restart the backend process and temporarily disconnect all clients.')) {
                    return;
                }

                this.isReloading = true;
                this.originalReloadButtonHtml = this.reloadButton.innerHTML;
                this.reloadButton.disabled = true;
                this.reloadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>RELOADING...';
                this.reloadButton.classList.remove('bg-pink-400', 'hover:bg-pink-300');
                this.reloadButton.classList.add('bg-gray-400');

                try {
                    this.addLog('Requesting server reload...', false);
                    const response = await fetch('/api/restart', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        this.addLog('Reload command sent successfully. Server will restart in 2 seconds.', false);
                    } else {
                        throw new Error(result.error?.message || 'Failed to send reload command');
                    }
                } catch (error) {
                    this.addLog(`Reload Error: ${error.message}`, true);
                    this.resetReloadButton();
                }
            }

            resetReloadButton() {
                this.isReloading = false;
                this.reloadButton.disabled = false;
                this.reloadButton.innerHTML = this.originalReloadButtonHtml || '<i class="fas fa-sync-alt mr-1"></i>RELOAD';
                this.reloadButton.classList.remove('bg-gray-400');
                this.reloadButton.classList.add('bg-pink-400');
            }

            async handleFormSubmit(e) {
                e.preventDefault();

                this.setButtonLoading(true);
                this.addLog('Starting automation...');

                try {
                    const response = await fetch('/api/run', {
                        method: 'POST',
                        body: new URLSearchParams(new FormData(this.automationForm))
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.currentJobId = result.data.jobId;
                        this.addLog(`Job started with ID: ${result.data.jobId}`);
                        this.switchTab('log'); // Auto-switch to logs when submitted
                        this.socket.emit('subscribeToJob', result.data.jobId);
                        this.resetForm(); // Clear the form after submission
                    } else {
                        throw new Error(result.error?.message || 'Failed to start automation');
                    }
                } catch (error) {
                    this.addLog(`Error: ${error.message}`, true);
                } finally {
                    this.setButtonLoading(false);
                }
            }

            async handleCheckPlan() {
                this.planContainer.innerHTML = '<div class="text-center text-slate-400 py-8"><i class="fas fa-spinner fa-spin fa-2x mb-3 text-blue-500"></i><br>Generating plan...</div>';
                this.planModal.classList.remove('hidden');

                try {
                    const response = await fetch('/api/check-plan', {
                        method: 'POST',
                        body: new URLSearchParams(new FormData(this.automationForm))
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.displayPlan(result.data.plan);
                    } else {
                        this.planContainer.innerHTML = `<div class="text-red-400 p-4 bg-red-500/10 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i>Error: ${result.error?.message || 'Failed to generate plan.'}</div>`;
                    }
                } catch (error) {
                    this.planContainer.innerHTML = '<div class="text-red-400 p-4 bg-red-500/10 rounded-lg"><i class="fas fa-server mr-2"></i>Failed to connect to server.</div>';
                }
            }

            displayPlan(plan) {
                if (!plan || plan.length === 0) {
                    this.planContainer.innerHTML = '<div class="text-slate-400 text-center py-8"><i class="fas fa-info-circle mb-2 fa-2x"></i><br>No campaigns found for the selected settings.</div>';
                    return;
                }

                this.planContainer.innerHTML = plan.map(item => {
                    const excludedText = item.excludedAdmins.length > 0
                        ? `Excluded: <span class="text-red-400">[${item.excludedAdmins.join(', ')}]</span>`
                        : 'No exclusions.';
                    const processingText = item.processingAdmins.length > 0
                        ? `Processing: <span class="text-green-400">[${item.processingAdmins.join(', ')}]</span>`
                        : '<span class="text-yellow-400">SKIPPED</span>';

                    return `<div class="border-b border-slate-700 pb-2 mb-2">
                        <strong class="text-white">Campaign ${item.campaignId}</strong><br>
                        <span class="text-slate-400 text-xs">${excludedText} &rarr; ${processingText}</span>
                    </div>`;
                }).join('');
            }

            closeModal() {
                this.planModal.classList.add('hidden');
            }

            clearLogs() {
                this.logContainer.innerHTML = '';
                this.addLog('Logs cleared.', false);
            }

            addLog(message, isError = false) {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('p');
                const logBg = isError ? 'bg-pink-100 border-pink-400' : (message.includes('[Backend]') ? 'bg-cyan-50 border-cyan-400' : 'bg-slate-50 border-slate-200');

                logEntry.className = `p-3 border-l-4 ${logBg} mb-3 text-black font-mono leading-tight rounded-r-lg shadow-sm`;
                logEntry.innerHTML = `<span class="opacity-40 text-[10px] block mb-1 font-bold tracking-tighter">${timestamp}</span> <span class="font-bold text-xs">${this.escapeHtml(message)}</span>`;

                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;



                // Update log counter if not on log tab
                if (this.activeTab !== 'log' && !message.includes('Connected to server')) {
                    this.newLogCount++;
                    this.updateLogCounter();
                }
            }

            updateLogCounter() {
                const counter = document.getElementById('logCounter');
                if (counter) {
                    counter.textContent = this.newLogCount;
                    counter.classList.remove('hidden');
                }
            }

            resetLogCounter() {
                this.newLogCount = 0;
                this.logCounter.textContent = this.newLogCount;
                this.logCounter.classList.add('hidden');
            }

            setButtonLoading(loading) {
                if (loading) {
                    this.automationButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                    this.automationButton.disabled = true;
                } else {
                    this.automationButton.innerHTML = '<i class="fas fa-play-circle mr-2"></i>Submit';
                    this.automationButton.disabled = false;
                }
            }

            isJobCompleteMessage(message) {
                return message.includes('Automation completed') || message.includes('Automation failed');
            }

            handleJobCompletion(logEntry) {
                if (!logEntry.isError && logEntry.message.includes('Automation completed')) {
                    this.resetForm();
                }
                this.setButtonLoading(false);
            }

            resetForm() {
                this.adminContainer.innerHTML = '';
                this.adminCount = 0;
                this.addAdminField();
            }

            updateVersionBadge() {
                if (this.versionBadge && this.currentConfig.version) {
                    this.versionBadge.textContent = `v${this.currentConfig.version}`;
                }
            }

            updateStatusIndicator(connected) {
                if (this.statusIndicator) {
                    this.statusIndicator.className = `w-2 h-2 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`;
                    this.statusIndicator.title = connected ? 'Connected' : 'Disconnected';
                }
            }

            async fetchHistory() {
                try {
                    const response = await fetch('/api/history');
                    const result = await response.json();

                    if (result.success) {
                        this.renderHistory(result.data);
                    }
                } catch (error) {
                    console.error('Failed to fetch history:', error);
                }
            }

            renderHistory(history) {
                if (!history || history.length === 0) {
                    this.historyList.innerHTML = `<div class="text-center py-8 text-slate-500">
                        <i class="fas fa-history fa-2x mb-3 opacity-20"></i>
                        <p>No submission history yet</p>
                    </div>`;
                    return;
                }

                this.historyList.innerHTML = history.map(entry => {
                    const date = new Date(entry.timestamp);
                    const formattedDate = date.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const browserColor = entry.browserType === 'remote' ? 'bg-purple-400' : 'bg-blue-400';

                    return `
                        <div class="bg-white p-5 border-2 border-black neo-shadow-sm hover:translate-x-0.5 hover:translate-y-0.5 hover:shadow-none transition-all rounded-xl">
                            <div class="flex justify-between items-start mb-4">
                                <div class="flex flex-wrap gap-2">
                                    ${entry.admins.map(admin => `
                                        <span class="text-[10px] font-extrabold bg-yellow-200 border-2 border-black px-2 py-0.5 uppercase tracking-tighter shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] rounded-md">
                                            ${admin}
                                        </span>
                                    `).join('')}
                                </div>
                                <span class="text-[10px] font-extrabold uppercase text-black italic opacity-40">${formattedDate}</span>
                            </div>
                            <div class="flex items-center justify-between border-t-2 border-black pt-4">
                                <div class="flex items-center space-x-4">
                                    <span class="px-2 py-1 bg-black text-white text-[9px] uppercase font-extrabold italic rounded-sm tracking-wider">
                                        ${entry.timeOfDay}
                                    </span>
                                    <span class="text-[9px] font-extrabold uppercase flex items-center">
                                        <span class="w-2.5 h-2.5 ${browserColor} border-2 border-black mr-2"></span>
                                        ${entry.browserType}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }



            escapeHtml(text) {

                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new EFEAdminApp();
        });
    </script>

    <!-- Progressive Web App Support -->
    <script>
        // Register service worker if available
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Handle online/offline status
        window.addEventListener('online', () => {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                indicator.title = 'Online';
            }
        });

        window.addEventListener('offline', () => {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                indicator.title = 'Offline';
            }
        });
    </script>
</body>

</html>