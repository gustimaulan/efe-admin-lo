<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch Admin EFE - Loops</title>

    <!-- External CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Disable Tailwind CDN warning in production
        if (window.location.hostname !== 'localhost') {
            const originalWarn = console.warn;
            console.warn = function (...args) {
                if (args[0] && args[0].includes('should not be used in production')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&family=Inter:wght@400;600;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --notion-bg: #FFFFFF;
            --notion-text: #000000;
            --notion-text-muted: #999999;
            --notion-border: #EAEAEA;
            --notion-hover: #F7F7F7;
            --notion-primary: #000000;
            --notion-secondary: #666666;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--notion-bg);
            color: var(--notion-text);
            -webkit-font-smoothing: antialiased;
        }

        h1,
        h2,
        h3,
        .heading-font {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        .notion-card {
            background-color: white;
            border: 1px solid var(--notion-border);
            border-radius: 8px;
            transition: box-shadow 0.2s ease;
        }

        .notion-card:hover {
            box-shadow: 0 1px 2px rgba(15, 15, 15, 0.1);
        }

        .notion-button {
            border: 1px solid var(--notion-border);
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.15s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .notion-button:hover {
            background: var(--notion-hover);
        }

        .notion-button-primary {
            background: var(--notion-primary);
            color: white;
            border-color: var(--notion-primary);
        }

        .notion-button-primary:hover {
            background: #333333;
        }

        .tab-btn {
            font-size: 15px;
            color: var(--notion-text-muted);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: var(--notion-hover);
        }

        .tab-btn.active {
            color: var(--notion-text);
            border-bottom-color: var(--notion-text);
        }

        /* Minimalist Input Styles */
        select,
        input[type="text"],
        input[type="radio"] {
            border: 1px solid var(--notion-border);
            border-radius: 4px;
            padding: 10px;
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }

        select:focus,
        input[type="text"]:focus {
            border-color: var(--notion-primary);
        }

        .log-entry {
            border-bottom: 1px solid var(--notion-border);
            padding: 8px 0;
        }
    </style>
</head>

<body class="p-4 sm:p-8">
    <div class="max-w-xl mx-auto space-y-10">
        <!-- Header with Version -->
        <header class="flex justify-between items-center mb-8 border-b border-gray-100 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">EFE Admin</h1>
                <p class="text-xs text-gray-500 font-medium">Loops Panel</p>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-[10px] font-semibold text-gray-500 border border-gray-200 px-2 py-0.5 rounded"
                    id="versionBadge">v{{VERSION}}</span>
                <div class="flex items-center space-x-3">
                    <button id="reloadButton"
                        class="notion-button text-[11px] h-7 px-2.5 text-gray-600 uppercase flex items-center"
                        title="Reload Server">
                        <i class="fas fa-sync-alt mr-1.5 opacity-60"></i>Reload
                    </button>
                    <div class="flex items-center space-x-2">
                        <div class="w-1.5 h-1.5 transition-colors duration-300 rounded-full bg-black shadow-[0_0_8px_rgba(0,0,0,0.1)]"
                            id="statusIndicator" title="System Status"></div>
                    </div>
                </div>
            </div>
        </header>


        <!-- Main Content Card -->
        <main class="notion-card overflow-hidden bg-white shadow-sm">

            <!-- Tab navigation -->
            <nav class="flex border-b border-gray-100 px-4">
                <button id="formTab" class="tab-btn active py-3 px-4 mr-2">
                    <i class="fas fa-edit mr-2 text-sm opacity-60"></i>Form
                </button>
                <button id="logTab" class="tab-btn py-3 px-4 mr-2 relative">
                    <i class="fas fa-list-ul mr-2 text-sm opacity-60"></i>Logs
                    <span id="logCounter"
                        class="absolute top-2 right-1 bg-gray-700 text-white text-[9px] font-bold w-4 h-4 flex items-center justify-center rounded-full hidden">0</span>
                </button>
                <button id="historyTab" class="tab-btn py-3 px-4">
                    <i class="fas fa-history mr-2 text-sm opacity-60"></i>History
                </button>
            </nav>




            <!-- Form tab content -->
            <section id="formContent" class="tab-content block p-8">
                <form id="automationForm" class="space-y-8">
                    <div class="space-y-3">
                        <label class="block text-sm font-semibold text-gray-500 uppercase tracking-wider">Browser
                            Selection</label>
                        <div class="flex space-x-8">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="browserType" value="local"
                                    class="text-black focus:ring-black h-5 w-5" checked>
                                <span class="ml-3 text-base text-gray-700 font-medium">Local</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" name="browserType" value="remote"
                                    class="text-black focus:ring-black h-5 w-5">
                                <span class="ml-3 text-base text-gray-700 font-medium">Remote <span
                                        class="text-[10px] bg-gray-100 text-gray-600 px-1.5 ml-1.5 rounded font-bold">BCAT</span></span>
                            </label>
                        </div>
                    </div>


                    <div class="space-y-4">
                        <label class="block text-sm font-semibold text-gray-500 uppercase tracking-wider">
                            Select Admins <span id="adminCounter" class="text-gray-400 font-normal"></span>
                        </label>
                        <div id="adminContainer" class="space-y-3">
                            <!-- Admin fields will be added here dynamically -->
                        </div>
                    </div>

                    <!-- Hidden fields -->
                    <input type="hidden" name="isManual" value="true" />
                    <input type="hidden" name="timeOfDay" value="manual" />
                    <input type="hidden" name="regularCampaigns" value="true" />

                    <!-- Form actions -->
                    <div class="flex items-center space-x-3 pt-4">
                        <button id="checkPlanButton" type="button" class="notion-button px-6 text-gray-700 font-medium">
                            Check Plan
                        </button>
                        <button id="automationButton" type="submit" class="notion-button notion-button-primary px-8">
                            <i class="fas fa-play text-[10px] mr-2 opacity-80"></i>Run Process
                        </button>
                    </div>
                </form>

            </section>


            <!-- Log tab content -->
            <section id="logContent" class="tab-content hidden p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800">Activity Logs</h2>
                    <button id="clearLogs" class="notion-button text-xs text-gray-500 hover:text-black">
                        Clear
                    </button>
                </div>
                <div id="logContainer"
                    class="space-y-1 max-h-[500px] overflow-y-auto font-mono text-xs border border-gray-100 p-4 rounded-lg bg-gray-50/50">
                    <!-- Log entries will be added here dynamically -->
                </div>
            </section>

            <!-- History tab content -->
            <section id="historyContent" class="tab-content hidden p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800">Past Jobs</h2>
                    <button id="refreshHistory" class="notion-button text-xs">
                        Refresh
                    </button>
                </div>
                <div id="historyList" class="space-y-3 max-h-[500px] overflow-y-auto">
                    <!-- History entries will be added here dynamically -->
                    <div class="text-center py-16 text-gray-400">
                        <i class="fas fa-history text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">Empty Archive</p>
                    </div>
                </div>
            </section>

        </main>

        <!-- Usage Instructions Section -->
        <section id="usageInstructionsSection"
            class="mt-8 notion-card p-8 bg-white shadow-sm rounded-xl border border-gray-100">
            <h3 class="text-base font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-info-circle mr-2 text-black opacity-60"></i>Petunjuk Penggunaan
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <ul class="space-y-4 text-[14px] text-gray-600">
                    <li class="flex items-start italic">
                        <span class="font-bold mr-3 text-black">1.</span>
                        <span><strong>Pilih Browser:</strong> Gunakan 'Local' untuk browser lokal atau 'Remote' untuk
                            BrowserCat (cloud). Jika bingung pilih 'Local' saja.</span>
                    </li>
                    <li class="flex items-start italic">
                        <span class="font-bold mr-3 text-black">2.</span>
                        <span><strong>Tentukan Admin:</strong> Masukkan nama admin. Gunakan tombol <strong
                                class="bg-black text-white px-1.5 py-0.5 rounded text-[12px]">+</strong>
                            untuk menambah
                            antrian.</span>
                    </li>
                    <li class="flex items-start italic">
                        <span class="font-bold mr-3 text-black">3.</span>
                        <span><strong>Cek Rencana:</strong> Kamu bisa melihat pembagian Admin dengan klik <strong>Check
                                Plan</strong> untuk memvalidasi
                            urutan kampanye.</span>
                    </li>
                    <li class="flex items-start italic">
                        <span class="font-bold mr-3 text-black">4.</span>
                        <span><strong>Jalankan:</strong> Klik <strong>Run Process</strong> untuk memulai. Pantau
                            realtime di tab <strong>Logs</strong>.</span>
                    </li>
                    <li class="flex items-start italic">
                        <span class="font-bold mr-3 text-black">5.</span>
                        <span><strong>Riwayat:</strong> Lihat tab <strong>History</strong> untuk laporan pekerjaan
                            selesai.</span>
                    </li>
                </ul>
                <div class="space-y-3">
                    <div class="text-[13px] text-gray-500 bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <i class="fas fa-id-badge mr-2 opacity-60"></i>
                        <strong class="text-gray-700">Info Admin WABA:</strong><br>
                        Selalu gunakan awalan <strong>9</strong>. <br>
                        Contoh: WABA1 → <strong>91</strong>, WABA2 → <strong>92</strong>, WABA15 → <strong>915</strong>.
                    </div>
                    <div class="text-[13px] text-gray-500 bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <i class="fas fa-sync-alt mr-2 opacity-60"></i>
                        <strong class="text-gray-700">Pemulihan Error:</strong><br>
                        Jika sistem bermasalah, gunakan tombol <strong>Reload</strong> di pojok kanan atas untuk memuat
                        ulang server.
                    </div>
                </div>
            </div>
        </section>


        <!-- Plan Check Modal -->
        <div id="planModal"
            class="fixed inset-0 bg-black/20 backdrop-blur-[2px] flex items-center justify-center z-50 p-4 hidden">
            <div class="bg-white notion-card p-6 w-full max-w-2xl mx-4 shadow-2xl relative">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold text-gray-800">
                        Planning Board
                    </h2>
                    <button id="closeModalButton" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="planContainer"
                    class="space-y-4 max-h-[60vh] overflow-y-auto font-mono text-sm text-gray-700 bg-gray-50/50 p-4 rounded-lg border border-gray-100">
                    <!-- Plan content will be added here dynamically -->
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center py-12 text-gray-300">
            <p class="text-[10px] font-medium tracking-widest uppercase">Env: {{ENVIRONMENT}} | Active: {{ACTIVE_ENV}}
            </p>
        </footer>
    </div>



    <!-- External JavaScript -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

    <!-- Consolidated Application Logic -->
    <script>
        /**
         * EFE Admin Tool - Frontend Application
         */

        class EFEAdminApp {
            constructor() {
                this.newLogCount = 0;
                this.activeTab = 'form';
                this.adminCount = 0;
                this.currentConfig = {};
                this.adminOptions = [];
                this.socket = null;
                this.currentJobId = null;
                this.isReloading = false;
                this.originalReloadButtonHtml = '';

                // Notion-style tag colors
                this.tagColors = [
                    { bg: 'bg-blue-50', text: 'text-blue-600', border: 'border-blue-100' },
                    { bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-100' },
                    { bg: 'bg-yellow-50', text: 'text-yellow-700', border: 'border-yellow-200' },
                    { bg: 'bg-pink-50', text: 'text-pink-600', border: 'border-pink-100' },
                    { bg: 'bg-purple-50', text: 'text-purple-600', border: 'border-purple-100' },
                    { bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-100' },
                    { bg: 'bg-teal-50', text: 'text-teal-600', border: 'border-teal-100' }
                ];

                this.init();
            }

            async init() {
                this.cacheDOMElements();
                this.bindEvents();
                await this.loadAdminOptions();
                this.initializeSocket();
                this.addAdminField();
            }

            cacheDOMElements() {
                // Tab elements
                this.formTab = document.getElementById('formTab');
                this.logTab = document.getElementById('logTab');
                this.historyTab = document.getElementById('historyTab');
                this.formContent = document.getElementById('formContent');
                this.logContent = document.getElementById('logContent');
                this.historyContent = document.getElementById('historyContent');
                this.logCounter = document.getElementById('logCounter');


                // Form elements
                this.automationForm = document.getElementById('automationForm');
                this.adminContainer = document.getElementById('adminContainer');
                this.automationButton = document.getElementById('automationButton');
                this.checkPlanButton = document.getElementById('checkPlanButton');

                // Log elements
                this.logContainer = document.getElementById('logContainer');
                this.clearLogsButton = document.getElementById('clearLogs');

                // History elements
                this.historyList = document.getElementById('historyList');
                this.refreshHistoryButton = document.getElementById('refreshHistory');


                // Modal elements
                this.planModal = document.getElementById('planModal');
                this.closeModalButton = document.getElementById('closeModalButton');
                this.planContainer = document.getElementById('planContainer');

                // Status elements
                this.versionBadge = document.getElementById('versionBadge');
                this.statusIndicator = document.getElementById('statusIndicator');
                this.reloadButton = document.getElementById('reloadButton');
                this.usageInstructionsSection = document.getElementById('usageInstructionsSection');
            }

            bindEvents() {
                // Tab switching
                this.formTab.addEventListener('click', () => this.switchTab('form'));
                this.logTab.addEventListener('click', () => {
                    this.switchTab('log');
                    this.resetLogCounter();
                });
                this.historyTab.addEventListener('click', () => {
                    this.switchTab('history');
                    this.fetchHistory();
                });


                // Form events
                this.automationForm.addEventListener('submit', (e) => this.handleFormSubmit(e));
                this.checkPlanButton.addEventListener('click', () => this.handleCheckPlan());
                this.clearLogsButton.addEventListener('click', () => this.clearLogs());
                this.refreshHistoryButton.addEventListener('click', () => this.fetchHistory());


                // Modal events
                this.closeModalButton.addEventListener('click', () => this.closeModal());
                this.planModal.addEventListener('click', (e) => {
                    if (e.target === this.planModal) this.closeModal();
                });

                // Reload event
                this.reloadButton.addEventListener('click', () => this.handleReload());
            }

            async loadAdminOptions() {
                // Temporary: Hardcoded admin options as requested
                const allowedAdmins = [
                    "admin 1", "admin 2", "admin 3", "admin 4", "admin 5",
                    "admin 6", "admin 7", "admin 8", "admin 09", "admin 10",
                    "admin 91", "admin 92", "admin 914", "admin 915",
                    "admin 916", "admin 917", "admin 918"
                ];

                this.adminOptions = allowedAdmins.map(name => ({
                    label: name,
                    value: name
                }));

                // Still try to fetch config for other settings silently, but don't block UI if it fails
                try {
                    const response = await fetch('/api/config');
                    const result = await response.json();
                    if (result.success) {
                        this.currentConfig = result.data;
                        this.updateVersionBadge();
                    }
                } catch (error) {
                    console.warn('Background config fetch failed, using defaults');
                }
            }

            initializeSocket() {
                // Initialize Socket.IO with specific transports and relative path to support both HTTP and HTTPS
                this.socket = io({
                    transports: ['polling', 'websocket'],
                    // Force insecure connection (HTTP/WS) as requested for IP address usage
                    secure: false,
                    rejectUnauthorized: false
                });

                this.socket.on('connect', () => {
                    this.addLog('Connected to server via WebSocket.', false);
                    this.updateStatusIndicator(true);

                    if (this.isReloading) {
                        this.resetReloadButton();
                    }
                });

                this.socket.on('disconnect', () => {
                    this.addLog('Disconnected from server.', true);
                    this.updateStatusIndicator(false);
                });

                this.socket.on('console_logs', (logEntry) => {
                    this.addLog(`[Backend] ${logEntry.message}`, logEntry.isError);
                });

                this.socket.on('newLog', (logEntry) => {
                    const message = logEntry.message.trim();
                    this.addLog(message, logEntry.isError);

                    if (this.isJobCompleteMessage(message)) {
                        this.handleJobCompletion(logEntry);
                    }
                });
            }

            switchTab(tab) {
                this.activeTab = tab;

                // Select tab buttons and contents
                const tabs = {
                    form: { btn: this.formTab, content: this.formContent },
                    log: { btn: this.logTab, content: this.logContent },
                    history: { btn: this.historyTab, content: this.historyContent }
                };


                // Reset all tabs
                Object.values(tabs).forEach(({ btn, content }) => {
                    btn.classList.remove('active', 'text-white', 'border-blue-500');
                    btn.classList.add('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                    content.classList.add('hidden');
                });

                // Set active tab
                const active = tabs[tab];
                active.btn.classList.remove('text-slate-400', 'border-transparent', 'hover:bg-slate-700/50');
                active.btn.classList.add('active', 'text-gray-900', 'border-gray-900');
                active.content.classList.remove('hidden');

                // Toggle usage instructions (only show on form tab)
                if (this.usageInstructionsSection) {
                    if (tab === 'form') {
                        this.usageInstructionsSection.classList.remove('hidden');
                    } else {
                        this.usageInstructionsSection.classList.add('hidden');
                    }
                }

                if (tab === 'form' && this.adminContainer.children.length === 0) {
                    this.addAdminField();
                }
            }

            createAdminField(index) {
                const adminDiv = document.createElement('div');
                adminDiv.className = 'flex items-center space-x-2 py-1.5 opacity-0 transition-all duration-300';
                adminDiv.dataset.adminIndex = index;

                const select = this.createAdminSelect(index);
                const buttonContainer = this.createButtonContainer();

                adminDiv.appendChild(select);
                adminDiv.appendChild(buttonContainer);

                // Trigger opacity transition
                setTimeout(() => adminDiv.classList.remove('opacity-0'), 10);

                return adminDiv;
            }

            createAdminSelect(index) {
                const select = document.createElement('select');
                select.name = `admin${index}`;
                select.className = 'flex-grow px-4 py-3 border border-gray-200 text-gray-800 text-base focus:border-black focus:outline-none transition-all rounded-md bg-white';
                select.required = true;



                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.disabled = true;
                defaultOption.selected = true;
                defaultOption.textContent = 'Select an admin';
                select.appendChild(defaultOption);

                this.adminOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    select.appendChild(option);
                });

                return select;
            }

            createButtonContainer() {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'flex items-center space-x-1';

                const addButton = this.createAddButton();
                const removeButton = this.createRemoveButton();

                buttonContainer.appendChild(addButton);
                buttonContainer.appendChild(removeButton);

                return buttonContainer;
            }

            createAddButton() {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'w-9 h-9 flex items-center justify-center rounded-md bg-black text-white hover:bg-gray-800 transition-all';
                button.innerHTML = '<i class="fas fa-plus text-xs"></i>';
                button.onclick = () => this.addAdminField();
                return button;
            }

            createRemoveButton() {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'rmv w-9 h-9 flex items-center justify-center rounded-md border border-gray-400 text-gray-400 hover:text-black hover:border-gray-800 hover:bg-gray-50 transition-all';
                button.innerHTML = '<i class="fas fa-minus text-xs"></i>';
                button.onclick = (e) => {
                    const field = e.target.closest('[data-admin-index]');
                    this.removeAdminField(field);
                };
                return button;
            }



            addAdminField() {
                this.adminCount++;
                const newField = this.createAdminField(this.adminCount);
                this.adminContainer.appendChild(newField);
                this.updateRemoveButtons();
                this.updateAdminCounter();
            }

            removeAdminField(field) {
                if (this.adminCount > 1) {
                    field.classList.add('opacity-0');
                    setTimeout(() => {
                        field.remove();
                        this.adminCount--;
                        this.updateRemoveButtons();
                        this.updateAdminCounter();
                    }, 300);
                }
            }

            updateRemoveButtons() {
                const removeButtons = this.adminContainer.querySelectorAll('.rmv');
                removeButtons.forEach(button => {
                    const disabled = this.adminCount <= 1;
                    button.disabled = disabled;
                    button.classList.toggle('opacity-50', disabled);
                    button.classList.toggle('cursor-not-allowed', disabled);
                });
            }

            updateAdminCounter() {
                const counter = document.getElementById('adminCounter');
                if (counter) {
                    counter.textContent = `(${this.adminCount})`;
                }
            }

            async handleReload() {
                if (!confirm('Are you sure you want to reload the server? This will restart the backend process and temporarily disconnect all clients.')) {
                    return;
                }

                this.isReloading = true;
                this.originalReloadButtonHtml = this.reloadButton.innerHTML;
                this.reloadButton.disabled = true;
                this.reloadButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>RELOADING...';
                this.reloadButton.classList.remove('bg-pink-400', 'hover:bg-pink-300');
                this.reloadButton.classList.add('bg-gray-400');

                try {
                    this.addLog('Requesting server reload...', false);
                    const response = await fetch('/api/restart', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        this.addLog('Reload command sent successfully. Server will restart in 2 seconds.', false);
                    } else {
                        throw new Error(result.error?.message || 'Failed to send reload command');
                    }
                } catch (error) {
                    this.addLog(`Reload Error: ${error.message}`, true);
                    this.resetReloadButton();
                }
            }

            resetReloadButton() {
                this.isReloading = false;
                this.reloadButton.disabled = false;
                this.reloadButton.innerHTML = this.originalReloadButtonHtml || '<i class="fas fa-sync-alt mr-1.5 opacity-60"></i>Reload';
                this.reloadButton.classList.remove('opacity-50');
            }

            async handleFormSubmit(e) {
                e.preventDefault();

                this.setButtonLoading(true);
                this.addLog('Starting automation...');

                try {
                    const response = await fetch('/api/run', {
                        method: 'POST',
                        body: new URLSearchParams(new FormData(this.automationForm))
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.currentJobId = result.data.jobId;
                        this.addLog(`Job started with ID: ${result.data.jobId}`);
                        this.switchTab('log'); // Auto-switch to logs when submitted
                        this.socket.emit('subscribeToJob', result.data.jobId);
                        this.resetForm(); // Clear the form after submission
                    } else {
                        throw new Error(result.error?.message || 'Failed to start automation');
                    }
                } catch (error) {
                    this.addLog(`Error: ${error.message}`, true);
                } finally {
                    this.setButtonLoading(false);
                }
            }

            async handleCheckPlan() {
                this.planContainer.innerHTML = '<div class="text-center text-slate-400 py-8"><i class="fas fa-spinner fa-spin fa-2x mb-3 text-blue-500"></i><br>Generating plan...</div>';
                this.planModal.classList.remove('hidden');

                try {
                    const response = await fetch('/api/check-plan', {
                        method: 'POST',
                        body: new URLSearchParams(new FormData(this.automationForm))
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.displayPlan(result.data.plan);
                    } else {
                        this.planContainer.innerHTML = `<div class="text-gray-500 p-4 bg-gray-50 rounded-lg"><i class="fas fa-exclamation-triangle mr-2"></i>Error: ${result.error?.message || 'Failed to generate plan.'}</div>`;
                    }
                } catch (error) {
                    this.planContainer.innerHTML = '<div class="text-gray-500 p-4 bg-gray-50 rounded-lg"><i class="fas fa-server mr-2"></i>Failed to connect to server.</div>';
                }
            }

            displayPlan(plan) {
                if (!plan || plan.length === 0) {
                    this.planContainer.innerHTML = '<div class="text-slate-400 text-center py-8"><i class="fas fa-info-circle mb-2 fa-2x"></i><br>No campaigns found for the selected settings.</div>';
                    return;
                }

                this.planContainer.innerHTML = plan.map(item => {
                    const formatAdmins = (admins, isExcluded) => {
                        if (admins.length === 0) return isExcluded ? 'No exclusions.' : '<span class="text-gray-400 italic">SKIPPED</span>';

                        return admins.map(admin => {
                            const color = this.getAdminColor(admin);
                            const baseClasses = isExcluded ? 'opacity-40 grayscale' : '';
                            return `<span class="inline-block text-[10px] font-medium ${color.bg} border ${color.border} ${color.text} px-1.5 py-0.5 rounded m-0.5 ${baseClasses}">${admin}</span>`;
                        }).join('');
                    };

                    const excludedText = formatAdmins(item.excludedAdmins, true);
                    const processingText = formatAdmins(item.processingAdmins, false);

                    return `<div class="border-b border-gray-100 last:border-0 pb-3 mb-3">
                        <div class="font-semibold text-black mb-1">Campaign ${item.campaignId}</div>
                        <div class="text-[12px] space-y-1">
                            <div class="flex items-start flex-wrap"><span class="text-gray-400 mr-2 mt-0.5 min-w-[80px]">Excluded:</span> ${excludedText}</div>
                            <div class="flex items-start flex-wrap"><span class="text-gray-400 mr-2 mt-0.5 min-w-[80px]">Processing:</span> ${processingText}</div>
                        </div>
                    </div>`;
                }).join('');
            }

            closeModal() {
                this.planModal.classList.add('hidden');
            }

            clearLogs() {
                this.logContainer.innerHTML = '';
                this.addLog('Logs cleared.', false);
            }

            addLog(message, isError = false) {
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const logEntry = document.createElement('div');
                const textColor = isError ? 'text-gray-800 font-bold' : 'text-gray-600';

                logEntry.className = 'py-2 border-b border-gray-100 last:border-0 flex items-start space-x-4';
                logEntry.innerHTML = `
                    <span class="text-[11px] text-gray-300 font-mono mt-0.5 shrink-0 w-16">${timestamp}</span>
                    <span class="text-[14px] leading-relaxed ${textColor}">${this.escapeHtml(message)}</span>
                `;

                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;



                // Update log counter if not on log tab
                if (this.activeTab !== 'log' && !message.includes('Connected to server')) {
                    this.newLogCount++;
                    this.updateLogCounter();
                }
            }

            updateLogCounter() {
                const counter = document.getElementById('logCounter');
                if (counter) {
                    counter.textContent = this.newLogCount;
                    counter.classList.remove('hidden');
                }
            }

            resetLogCounter() {
                this.newLogCount = 0;
                this.logCounter.textContent = this.newLogCount;
                this.logCounter.classList.add('hidden');
            }

            setButtonLoading(loading) {
                if (loading) {
                    this.automationButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2 opacity-60"></i>Processing...';
                    this.automationButton.disabled = true;
                    this.automationButton.classList.add('opacity-70', 'cursor-not-allowed');
                } else {
                    this.automationButton.innerHTML = '<i class="fas fa-play text-[10px] mr-2 opacity-80"></i>Run Process';
                    this.automationButton.disabled = false;
                    this.automationButton.classList.remove('opacity-70', 'cursor-not-allowed');
                }
            }

            isJobCompleteMessage(message) {
                return message.includes('Automation completed') || message.includes('Automation failed');
            }

            handleJobCompletion(logEntry) {
                if (!logEntry.isError && logEntry.message.includes('Automation completed')) {
                    this.resetForm();
                }
                this.setButtonLoading(false);
            }

            resetForm() {
                this.adminContainer.innerHTML = '';
                this.adminCount = 0;
                this.addAdminField();
            }

            updateVersionBadge() {
                if (this.versionBadge && this.currentConfig.version) {
                    this.versionBadge.textContent = `v${this.currentConfig.version}`;
                }
            }

            updateStatusIndicator(connected) {
                if (this.statusIndicator) {
                    this.statusIndicator.className = `w-1.5 h-1.5 rounded-full ${connected ? 'bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]' : 'bg-gray-300'}`;
                    this.statusIndicator.title = connected ? 'Connected' : 'Disconnected';
                }
            }

            async fetchHistory() {
                try {
                    const response = await fetch('/api/history');
                    const result = await response.json();

                    if (result.success) {
                        this.renderHistory(result.data);
                    }
                } catch (error) {
                    console.error('Failed to fetch history:', error);
                }
            }

            getAdminColor(name) {
                let hash = 0;
                for (let i = 0; i < name.length; i++) {
                    hash = name.charCodeAt(i) + ((hash << 5) - hash);
                }
                return this.tagColors[Math.abs(hash) % this.tagColors.length];
            }

            renderHistory(history) {
                if (!history || history.length === 0) {
                    this.historyList.innerHTML = `<div class="text-center py-16 text-gray-400">
                        <i class="fas fa-history text-4xl mb-3 opacity-20"></i>
                        <p class="text-sm">Empty Archive</p>
                    </div>`;
                    return;
                }

                this.historyList.innerHTML = history.map(entry => {
                    const date = new Date(entry.timestamp);
                    const formattedDate = date.toLocaleString('en-GB', {
                        day: '2-digit',
                        month: 'short',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    return `
                        <div class="bg-white p-4 border border-gray-100 rounded-lg hover:border-gray-200 hover:shadow-sm transition-all">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex flex-wrap gap-2">
                                    ${entry.admins.map(admin => {
                        const color = this.getAdminColor(admin);
                        return `
                                            <span class="text-[13px] font-semibold ${color.bg} border ${color.border} ${color.text} px-3 py-1 rounded">
                                                ${admin}
                                            </span>
                                        `;
                    }).join('')}
                                </div>
                                <span class="text-[11px] font-medium text-gray-400">${formattedDate}</span>
                            </div>
                            <div class="flex items-center justify-between text-[13px] text-gray-400">
                                <div class="flex items-center space-x-5">
                                    <span class="text-gray-400 lowercase font-medium">
                                        ${entry.timeOfDay}
                                    </span>
                                    <span class="flex items-center">
                                        <span class="w-1.5 h-1.5 bg-black rounded-full mr-2 opacity-30"></span>
                                        ${entry.browserType}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }



            escapeHtml(text) {

                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new EFEAdminApp();
        });
    </script>

    <!-- Progressive Web App Support -->
    <script>
        // Register service worker if available
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Handle online/offline status
        window.addEventListener('online', () => {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.className = 'w-1.5 h-1.5 rounded-full bg-black shadow-[0_0_8px_rgba(0,0,0,0.1)]';
                indicator.title = 'Online';
            }
        });

        window.addEventListener('offline', () => {
            const indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.className = 'w-1.5 h-1.5 rounded-full bg-gray-200';
                indicator.title = 'Offline';
            }
        });
    </script>
</body>

</html>