<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Switch Admin EFE - Loops</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-100 p-10">
    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-semibold text-center mb-4">Switch Admin EFE - Loops</h1>
        <form id="automationForm" class="space-y-4">
            <div id="adminContainer">
                <!-- Admin fields will be added here dynamically -->
            </div>
            <div class="mb-3">
                <label class="block mb-1 font-medium text-sm text-blue-500">Campaign Selection</label>
                <div class="space-y-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="regularCampaigns" name="regularCampaigns" value="true" class="mr-2">
                        <label for="regularCampaigns" class="text-sm">Regular Campaign</label>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="tiktokCampaigns" name="tiktokCampaigns" value="true" class="mr-2">
                        <label for="tiktokCampaigns" class="text-sm">Tiktok Campaign</label>
                    </div>
                </div>
            </div>
            <!-- Hidden fields -->
            <input type="hidden" name="isManual" value="true">
            <input type="hidden" name="timeOfDay" value="manual">
            <div class="text-center">
                <button id="automationButton" type="submit" class="bg-blue-500 hover:bg-black focus:bg-black text-white px-4 py-2 rounded">
                    Start Automation
                </button>
            </div>
        </form>
    </div>

    <div id="log-container" class="max-w-md mx-auto p-6">
        <h2 class="text-lg font-semibold">Logs</h2>
        <div id="logContainer" class="space-y-2"></div>
    </div>

    <script>
        const logContainer = document.getElementById('logContainer');
        const startButton = document.getElementById('automationButton');
        const automationForm = document.getElementById('automationForm');
        const adminContainer = document.getElementById('adminContainer');
        let adminCount = 0;

        // Admin options
        const adminOptions = [
            "admin 1", "admin 2", "admin 3", "admin 4", 
            "admin 5", "admin 6", "admin 7"
        ];

        // Add initial admin field
        addAdminField();

        function createAdminField(index) {
            const adminDiv = document.createElement('div');
            adminDiv.className = 'mb-3';
            adminDiv.dataset.adminIndex = index;
            
            // Create label
            const label = document.createElement('label');
            label.htmlFor = `admin${index}`;
            label.className = 'block mb-1 font-medium text-blue-500 text-sm';
            label.textContent = `Admin ke-${index}`;
            adminDiv.appendChild(label);
            
            // Create a flex container for select and buttons
            const flexContainer = document.createElement('div');
            flexContainer.className = 'flex items-center space-x-2';
            
            // Create select element
            const select = document.createElement('select');
            select.name = `admin${index}`;
            select.id = `admin${index}`;
            select.className = 'flex-grow p-2 border rounded';
            select.required = true;
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.disabled = true;
            defaultOption.selected = true;
            defaultOption.textContent = 'Select an admin';
            select.appendChild(defaultOption);
            
            // Add admin options
            adminOptions.forEach(adminName => {
                const option = document.createElement('option');
                option.value = adminName;
                option.textContent = adminName.charAt(0).toUpperCase() + adminName.slice(1);
                select.appendChild(option);
            });

            // Add select to flex container
            flexContainer.appendChild(select);
            
            // Create button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex space-x-1';
            
            // Add plus button
            const addButton = document.createElement('button');
            addButton.type = 'button';
            addButton.className = 'bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded';
            addButton.innerHTML = '<i class="fas fa-plus"></i>';
            addButton.addEventListener('click', () => addAdminField(index + 1));
            
            // Add minus button
            const removeButton = document.createElement('button');
            removeButton.type = 'button';
            removeButton.className = 'bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded';
            removeButton.innerHTML = '<i class="fas fa-minus"></i>';
            removeButton.addEventListener('click', () => removeAdminField(index));
            
            // Disable remove button if it's the only admin
            if (adminCount <= 1) {
                removeButton.disabled = true;
                removeButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
            
            buttonContainer.appendChild(addButton);
            buttonContainer.appendChild(removeButton);
            
            // Add buttons to flex container
            flexContainer.appendChild(buttonContainer);
            
            // Add flex container to admin div
            adminDiv.appendChild(flexContainer);
            
            return adminDiv;
        }

        function reindexAdminFields() {
            const adminDivs = adminContainer.querySelectorAll('div[data-admin-index]');
            adminDivs.forEach((div, i) => {
                const newIndex = i + 1;
                div.dataset.adminIndex = newIndex;
                
                // Update label
                const label = div.querySelector('label');
                label.htmlFor = `admin${newIndex}`;
                label.textContent = `Admin ${newIndex}`;
                
                // Update select
                const select = div.querySelector('select');
                select.name = `admin${newIndex}`;
                select.id = `admin${newIndex}`;
            });
        }

        function addAdminField(positionIndex) {
            adminCount++;
            const newAdminField = createAdminField(adminCount);
            
            if (positionIndex) {
                // Insert at specific position
                const adminDivs = adminContainer.querySelectorAll('div[data-admin-index]');
                let inserted = false;
                
                for (let i = 0; i < adminDivs.length; i++) {
                    const currentIndex = parseInt(adminDivs[i].dataset.adminIndex);
                    if (currentIndex >= positionIndex) {
                        adminContainer.insertBefore(newAdminField, adminDivs[i]);
                        inserted = true;
                        break;
                    }
                }
                
                if (!inserted) {
                    adminContainer.appendChild(newAdminField);
                }
            } else {
                // Append at the end
                adminContainer.appendChild(newAdminField);
            }
            
            // Update all remove buttons
            updateRemoveButtons();
        }

        function removeAdminField(index) {
            if (adminCount > 1) {
                // Find the admin div with the matching index
                const adminDivToRemove = adminContainer.querySelector(`div[data-admin-index="${index}"]`);
                if (adminDivToRemove) {
                    adminContainer.removeChild(adminDivToRemove);
                    adminCount--;
                    
                    // Reindex remaining admin fields
                    reindexAdminFields();
                    
                    // Update all remove buttons
                    updateRemoveButtons();
                }
            }
        }

        function updateRemoveButtons() {
            const removeButtons = adminContainer.querySelectorAll('button:has(.fa-minus)');
            
            removeButtons.forEach(button => {
                if (adminCount <= 1) {
                    button.disabled = true;
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.disabled = false;
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }

        function addLog(message, isError = false) {
            const logEntry = document.createElement('div');
            logEntry.className = `${isError ? 'text-red-600' : 'text-green-600'} opacity-0 transition-opacity duration-300`;
            logEntry.textContent = message;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Trigger fade-in effect
            setTimeout(() => {
                logEntry.classList.remove('opacity-0');
            }, 50);
        }

        function resetForm() {
            // Reset admin fields
            const adminFields = adminContainer.querySelectorAll('div[data-admin-index]');
            // Remove all admin fields except the first one
            for (let i = adminFields.length - 1; i > 0; i--) {
                adminFields[i].remove();
            }
            // Reset the first admin field's select value
            if (adminFields[0]) {
                adminFields[0].querySelector('select').value = '';
            }
            adminCount = 1;
            
            // Reset campaign checkboxes
            document.getElementById('regularCampaigns').checked = false;
            document.getElementById('tiktokCampaigns').checked = false;
            
            // Reset the button
            resetButton();
        }

        automationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Check if at least one campaign type is selected
            const regularCampaigns = document.getElementById('regularCampaigns').checked;
            const tiktokCampaigns = document.getElementById('tiktokCampaigns').checked;

            if (!regularCampaigns && !tiktokCampaigns) {
                addLog('Please select at least one campaign type', true);
                return;
            }

            changeButtonText();

            const formData = new FormData(automationForm);
            addLog('Starting automation...');

            try {
                const response = await fetch('/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(formData)
                });

                const result = await response.json();
                if (response.ok) {
                    const jobId = result.jobId;
                    addLog('Processing your request...', false);
                    
                    const statusCheck = setInterval(async () => {
                        try {
                            const statusResponse = await fetch(`/status/${jobId}`);
                            const statusResult = await statusResponse.json();
                            
                            if (statusResponse.ok) {
                                if (statusResult.status === 'completed') {
                                    clearInterval(statusCheck);
                                    if (statusResult.success) {
                                        addLog('Automation completed successfully! ✅', false);
                                        resetForm();
                                    } else {
                                        addLog('Automation completed with errors ❌', true);
                                        resetButton();
                                    }
                                } else if (statusResult.status === 'error') {
                                    clearInterval(statusCheck);
                                    addLog(`Error: ${statusResult.message} ❌`, true);
                                    resetButton();
                                }
                            } else {
                                clearInterval(statusCheck);
                                addLog('Lost track of job status ❌', true);
                                resetButton();
                            }
                        } catch (error) {
                            clearInterval(statusCheck);
                            addLog(`Error checking status: ${error.message} ❌`, true);
                            resetButton();
                        }
                    }, 2000);
                    
                    // Stop polling after 10 minutes maximum
                    setTimeout(() => {
                        clearInterval(statusCheck);
                        addLog('Operation timed out ❌', true);
                        resetButton();
                    }, 600000);
                    
                } else {
                    addLog(`Error: ${result.message} ❌`, true);
                    resetButton();
                }
            } catch (error) {
                addLog(`Error: ${error.message} ❌`, true);
                resetButton();
            }
        });

        function changeButtonText() {
            const button = document.getElementById("automationButton");
            button.textContent = "Processing...";
            button.disabled = true; // Disable button to prevent multiple submissions
            button.classList.add("opacity-50", "cursor-not-allowed"); // Styling for disabled state
        }

        function resetButton() {
            startButton.disabled = false;
            startButton.textContent = "Start Automation";
            startButton.classList.remove("opacity-50", "cursor-not-allowed");
        }

        // Add a function to format duration
        function formatDuration(startTime, endTime) {
            const duration = Math.floor((new Date(endTime) - new Date(startTime)) / 1000);
            return `${duration} seconds`;
        }
    </script>
</body>

</html>
